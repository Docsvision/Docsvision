= Служба фоновых операций
:revnumber: 6.1
:doctype: book
:underscore: _
:page-component-name: workerservice
:page-component-version: 6.1
:page-version: {page-component-version}
:page-component-display-version: 6.1
:page-component-title: Служба фоновых операций

:docname: index
:page-module: ROOT
:page-relative-src-path: index.adoc
:page-origin-url: https://github.com/Docsvision/Worker-Antora.git
:page-origin-start-path:
:page-origin-refname: 6.1
:page-origin-reftype: branch
:page-origin-refhash: 0d5cadd3daebde21bfc76e6f8e6b90260f0d4e84

Модуль _Служба {ws}_ является _базовым модулем_ системы {dv}.
// , который реализует функции СУБП и предоставляет инструментарий для настройки БП.

[WARNING]
====
Служба {ws} данной версии несовместима с модулем {sm}.
====

[#index:::purpose]
== Назначение документации

Настоящий раздел документации содержит описание модуля, инструкцию по установке и руководство по администрированию модуля _Служба {ws}_.

Документация предназначена для сотрудников, выполняющих установку _Службы {ws}_.

[#index:::arrangement]
== Как организована документация модуля

.Документация содержит следующие разделы:
. <<functions:::>> -- в разделе приведены общие сведения о Службе {ws},
. <<requirements:::>> -- в разделе перечислены требования к программному и аппаратному обеспечению компьютера для установки модуля.
. <<module-structure:::>> -- в разделе перечислены составные части Службы {ws}.
. <<admin:install:::>> -- раздел содержит инструкцию по установке модуля.
. <<admin:work-log:::>> -- в данном разделе описаны настройки журналирования работы модуля.

[#__object-id-502822]
== Общие сведения о модуле

:docname: functions
:page-module: ROOT
:page-relative-src-path: functions.adoc
:page-origin-url: https://github.com/Docsvision/Worker-Antora.git
:page-origin-start-path:
:page-origin-refname: 6.1
:page-origin-reftype: branch
:page-origin-refhash: 0d5cadd3daebde21bfc76e6f8e6b90260f0d4e84
[#functions:::]
=== Назначение и функции модуля

Служба {ws} предназначена для выполнения задач, поступивших от других модулей {dv} в фоновом режиме. Модули могут делегировать Службе {ws} обработку данных или выполнение иных длительных задач, для которых не требуется немедленное получение результата и возможно выполнение вне {of-ws} модуля.

.В модуле Служба {ws} реализованы следующие функции:
* Выполнение задач различных типов:
** Сервисные задачи.
** Периодические задачи.
** Задачи по расписанию.
** Задачи по получению сообщения в очереди.
* Создание дополнений, расширяющих функции модуля.
* Изоляция выполнения задач определённого типа в выделенном физическом процессе.
* Создание кластера Службы {ws} для параллельной обработки задач.
// * Отправка почтового уведомления о завершении задания автору.
// * Отправка почтового уведомления о завершении группы заданий автору.
// * Отправка почтового уведомления об отклонении задания автору.
// * Отправка почтового уведомления о начале приёмки задания.
// * Отправка почтовых уведомлений.

:docname: module-structure
:page-module: ROOT
:page-relative-src-path: module-structure.adoc
:page-origin-url: https://github.com/Docsvision/Worker-Antora.git
:page-origin-start-path:
:page-origin-refname: 6.1
:page-origin-reftype: branch
:page-origin-refhash: 0d5cadd3daebde21bfc76e6f8e6b90260f0d4e84
[#module-structure:::]
=== Структура модуля

Модуль Служба {ws} состоит из двух частей: серверная и клиентская.

[#module-structure:::серверная-часть-модуля]
==== Серверная часть модуля

Серверная часть модуля Служба {ws} включает следующие компоненты: _Серверные компоненты_ и _Служба {ws}_.

// === Компонент "Служба {ws}"

Компонент "Служба {ws}" включает *основные* составляющие модуля.

// .Составляющие компонента "Служба {ws}":
// * `WorkerService.exe` -- исполняемый файл службы *{wss-new}*. Служба осуществляет запуск и контроль над порождаемыми фоновыми операциями.
// +
****
.Служба *{wss-new}* реализует следующие функции:
** Загрузка конфигурации {ws} (_WorkerProcess_).
** Запуск требуемого количества {ws} с передачей им конфигурации.
** Контроль запущенности каждого {of-ws} и перезапуск остановленных.
** Остановка {ws} при остановке службы.
****
// +
// * `WorkerProcess.exe` и `WorkerProcess32.exe` -- исполняемые файлы Службы {ws} (x64 и x32-версии).
// +
****
.Фоновая операция (_WorkerProcess_) реализует следующие функции:
* Загрузка программных компонентов, указанных в полученной от _WorkerService_ конфигурации.
* Выполнение и контроль функций, реализованных в загруженных компонентах.
****

[#module-structure:::компонент-серверные-компоненты]
===== Компонент "Серверные компоненты"

.Компонент "Серверные компоненты" включает следующие составляющие:
* Библиотека карточек "Служба {ws}".
* Библиотеки `.dll` с объектной моделью карточек и API модуля.
* Клиентский инсталлятор, содержащий клиентские библиотеки `.dll` с объектной моделью карточек модуля и API модуля.

Загружаемые компоненты и необходимые для выполнения их функции настройки предоставляются устанавливаемыми расширениями для Службы {ws}. Расширения являются частью модулей {dv}, использующих Службу {ws}.

:docname: requirements
:page-module: ROOT
:page-relative-src-path: requirements.adoc
:page-origin-url: https://github.com/Docsvision/Worker-Antora.git
:page-origin-start-path:
:page-origin-refname: 6.1
:page-origin-reftype: branch
:page-origin-refhash: 0d5cadd3daebde21bfc76e6f8e6b90260f0d4e84
[#requirements:::]
== Необходимые ресурсы

[#requirements:::hard]
=== Необходимое техническое обеспечение

Специальные требования не предъявляются.

[#requirements:::soft]
=== Необходимое программное обеспечение

.Сервер {dv} работает под управлением Linux:
* Astra Linux Special Edition {l-1}.

.Машина с Windows необходима для работы с Консолью настройки {dv} и {wincl}ом:
* Microsoft Windows Server {serv-2} и выше.
// * *Обязательное программное обеспечение:* Microsoft .NET Framework {net-v1}.

[#requirements:::dv]
=== Требования к системе {dv}

Модуль _Служба {ws}_ является обязательным для полноценной работы модулей {bo} и {ad}.

[#requirements:::separate]
=== Требования для установки на отдельную машину

Модуль Служба {ws} может устанавливаться на отдельную от сервера {dv} машину, см. "<<admin:install:::>>". При этом к данной машине выдвигаются дополнительные требования.

.На отдельном сервере должны быть установлены серверные части следующих модулей:
* {pl} версии {pl-req} и выше.
* {ad} версии {ad-req} и выше.
* {bo} версии {bo-req} и выше.
* {dm} версии {dm-req} и выше.
* {wf} версии {wf-req} и выше.

:docname: requirements-account
:page-module: ROOT
:page-relative-src-path: requirements-account.adoc
:page-origin-url: https://github.com/Docsvision/Worker-Antora.git
:page-origin-start-path:
:page-origin-refname: 6.1
:page-origin-reftype: branch
:page-origin-refhash: 0d5cadd3daebde21bfc76e6f8e6b90260f0d4e84
[#requirements-account:::]
=== Требования к учетной записи Службы фоновых операций

_Служба {ws}_ является базовым модулем системы {dv}. Для учётной записи, от имени которой запускается служба *{wss-new}* требуются такие же права, как и для учётной записи модуля _{wf}_. Подробно требования перечислены ниже.

// . Полный доступ к функциям администратора. Пользователь, от имени которого запускается _Служба {ws}_, должен состоять в группе локальных администраторов (*Administrators*) на сервере со _Службой {ws}_.
// . _Служба {ws}_ считывает настройки из _{of-sett-serv}_, что требует соответствующих прав.
// +
// include::admin:launch.adoc[tags=console]
// +
. Членство в группе *{dv-sys-wf-dir}*. Доменная учётная запись, от имени которой запускается _Служба {ws}_ должна состоять в группе *{dv-sys-wf-dir}* в справочнике сотрудников на сервере {dv}. Эта же УЗ должна быть указана в Консоли управления для подключения Службы {ws} к серверу. См. документацию модуля {mc}, раздел "xref:6.1@mgmtconsole:user:connections-docsvision.adoc[]".
+
WARNING: Используйте учётную запись, которая будет указана в _{of-mc}_ для подключения Службы {ws} к серверу.

:docname: index
:page-module: common
:page-relative-src-path: index.adoc
:page-origin-url: https://github.com/Docsvision/Worker-Antora.git
:page-origin-start-path:
:page-origin-refname: 6.1
:page-origin-reftype: branch
:page-origin-refhash: 0d5cadd3daebde21bfc76e6f8e6b90260f0d4e84
[#common:index:::]
== Изменения, обновления и исправленные ошибки
:page-layout: home


[tab#common:index:::tabs-1s]
====
[#common:index:::tabs-1-служба-фоновых-операций]
Служба {ws}::
+
.Общая документация
****
Общая информация об изменениях, исправленных ошибках и накопительных обновлениях.

* <<common:change-log:::>>
* <<common:bugs:::>>
* <<common:patches-log:::,Накопительные обновления>>
****
====

:!page-layout:

:docname: change-log
:page-module: common
:page-relative-src-path: change-log.adoc
:page-origin-url: https://github.com/Docsvision/Worker-Antora.git
:page-origin-start-path:
:page-origin-refname: 6.1
:page-origin-reftype: branch
:page-origin-refhash: 0d5cadd3daebde21bfc76e6f8e6b90260f0d4e84
[#common:change-log:::]
=== Изменения в релизной версии

* Новая версия модуля переведена на .NET 6.0 с возможностью установки на ОС Astra Linux.
* Версии управляемых компонентов {dv} (.NET) были изменены с 5.5 на 6.0. Версии неуправляемых компонентов {dv} (С++, VB 6.0) не изменились.

:docname: bugs
:page-module: common
:page-relative-src-path: bugs.adoc
:page-origin-url: https://github.com/Docsvision/Worker-Antora.git
:page-origin-start-path:
:page-origin-refname: 6.1
:page-origin-reftype: branch
:page-origin-refhash: 0d5cadd3daebde21bfc76e6f8e6b90260f0d4e84
[#common:bugs:::]
==== Исправленные ошибки

[cols="34,66", frame=none, grid=none]
|===
|ERR-3793 (SUP-7494)
|В документации отсутствовала информация о несовместимости _Службы {ws}_ версии 5.5.2 с модулем _{sm}_.

|TSK-902 (SUP-5624)
|Ошибки Службы {ws} не фиксировались в журнале работы или консоли.
|===

:docname: patches-log
:page-module: common
:page-relative-src-path: patches-log.adoc
:page-origin-url: https://github.com/Docsvision/Worker-Antora.git
:page-origin-start-path:
:page-origin-refname: 6.1
:page-origin-reftype: branch
:page-origin-refhash: 0d5cadd3daebde21bfc76e6f8e6b90260f0d4e84
[#common:patches-log:::]
=== Накопительные обновления

[#__object-id-510586]
== Администрирование модуля

:docname: install
:page-module: admin
:page-relative-src-path: install.adoc
:page-origin-url: https://github.com/Docsvision/Worker-Antora.git
:page-origin-start-path:
:page-origin-refname: 6.1
:page-origin-reftype: branch
:page-origin-refhash: 0d5cadd3daebde21bfc76e6f8e6b90260f0d4e84
[#admin:install:::]
=== Установка и настройка Службы фоновых операций
// tag::linux[]
:of: сервиса
:wt: workerservice
:config: Configuration



Пользователь, выполняющий установку Службы {ws}, должен обладать правами локального администратора.

// tag::sm-incompat[]
Служба {ws} данной версии несовместима с модулем {sm}.
// end::sm-incompat[]

WARNING: Перед установкой ознакомьтесь с разделом "xref:6.1@workerservice:ROOT:requirements.adoc[]".

+
Основные настройки, которые нужно сделать:
+
[source,json]
----
{
  "SettingsServiceConnectionString": "ConnectAddress=http://settings.domain.com:5200/api", <.>
  "ApiKey": "anything", <.>
  "RestApiAddress": "http://worker.domain.com:5900/api", <.>
  "LogFile": "/var/log/docsvision/WorkerService.log" <.>
}
----
<.> Адрес подключения к Сервису настроек.
<.> Ключ доступа к Сервису настроек -- "пароль", который также должен быть указан в конфигурационном файле сервиса.
<.> Адрес подключения к Службе {ws}.
<.> Путь к файлу журнала Службы {ws}
+
. Запустите службу модуля:
+
[source,bash]
----
sudo systemctl start dvworkerservice
----
// end::linux[]

[#admin:install:::windows]
==== Установка Службы {ws} на Windows

Пользователь, выполняющий установку Службы {ws}, должен обладать правами локального администратора.

// WARNING: При первичной установке модуль должен устанавливаться сразу после модуля _{pl}_ и перед модулями _{ad}_ и _{bo}_. В противном случае необходимые расширения Службы {ws} не буду загружены в БД.

. Запустите пакет установки `{dv} WorkerService.msi`.
+
.Мастер установки Службы {ws}
image::workerservice/6.1/admin/_images/install-hello.png[Мастер установки Службы {ws}]
+
. Примите условия лицензионного соглашения, чтобы продолжить установку, и нажмите кнопку *Далее*.
+
.Условия лицензионного соглашения
image::workerservice/6.1/admin/_images/install-license.png[Условия лицензионного соглашения]
+
. Выберите компоненты, которые требуется установить.
+
.Выбор устанавливаемых компонентов Службы {ws}
image::workerservice/6.1/admin/_images/install-components.png[Выбор устанавливаемых компонентов Службы {ws}]
+
****
Служба {ws}::
Устанавливает основные файлы Службы {ws}.

Серверные компоненты::
Когда компонент выбран, устанавливается библиотека карточек. Перед завершением установки будет запущена _{cns}_ для обновления БД.
+
[WARNING]
====
При установке серверных компонентов модуля на Windows требуется устанавливать только компонент "Серверные компоненты". Остальные компоненты будут установлены на сервер Linux.
====

Кнопки::
* *Сброс* -- сбрасывает выбор компонентов на стандартные
* *Использование диска* -- позволяет посмотреть свободное место на системных дисках.
****
+
//tag::confirm[]
. Нажмите кнопку *Установить*, чтобы начать установку или кнопку *Назад*, чтобы вернуться на предыдущий шаг.
//end::confirm[]
+
.Продолжить установку или вернуться на предыдущий шаг
image::workerservice/6.1/admin/_images/install-check.png[Продолжить установку или вернуться на предыдущий шаг]
+
// . Не устанавливайте флаг `*Обновить базу данных (WorkerService)*`.
// +
//tag::finish[]
. Нажмите кнопку *Готово*, чтобы закрыть мастер установки.
//end::finish[]
+
+
. Запустите {wincl}. При подключении к серверу {dv} с установленной серверной частью модуля, клиентская часть модуля будет установлена автоматически.

[#admin:install:::установка-клиентской-части-модуля-из-установочного-пакета]
==== Установка клиентской части модуля из установочного пакета

.Чтобы установить клиентскую часть модуля вручную:
. Запустите пакет установки `{dv} Worker service client.msi` вручную.
+
Для установки клиентской части модуля используются область и каталог установки, указанные в конфигурационном файле модуля {pl}, см. документацию модуля {pl} xref:6.1@platform:console:config-client.adoc[].
// (указана в приветственном окне мастера установки)  установки, которые были использованы при установке модуля {pl}.
+
. Примите условия лицензионного соглашения, чтобы продолжить установку.
. Нажмите на кнопку *Установить* и дождитесь завершения установки модуля.
. Нажмите на кнопку *Готово*, чтобы закрыть мастер установки.

:!of:
:!wt:
:config: appsettings

:docname: update-module
:page-module: admin
:page-relative-src-path: update-module.adoc
:page-origin-url: https://github.com/Docsvision/Worker-Antora.git
:page-origin-start-path:
:page-origin-refname: 6.1
:page-origin-reftype: branch
:page-origin-refhash: 0d5cadd3daebde21bfc76e6f8e6b90260f0d4e84
[#admin:update-module:::]
=== Обновление модуля
:update: workerservice-*



* Установка новой версии должна выполняться в нерабочее время.
* Создайте резервную копию БД {dv}.
* База данных {dv} должна быть переведена на работу с расширенными метаданными.
* При обновлении версия клиентского дистрибутива должна быть равной версии серверного дистрибутива.
* Если к новой версии модуля приложена инструкция по обновлению, следуйте ей.
* *Если комплект обновления включает обновление для модуля "{pl}"*, перейдите к инструкции, приведенной xref:6.1@platform:admin:update-module.adoc[в документации] модуля {pl}.

+
`{dv} Worker service client.msi`.
+
// [#multiple-modules]
// == Обновление нескольких модулей
//
// Если планируется обновлять несколько модулей, следующие действия следует выполнять один раз после установки новых версий всех модулей:
//
// . Откройте _{cns}_.
// +
// Пользователь, от имени которого запускается _{cns}_ должен являться администратором {dv}, а также входить в группы {dv} в Справочнике сотрудников: _{dv-dm-admins-dir}_, _{dv-ad-admins-dir}_ и _{dv-sys-wf-dir}_.
// +
// . На странице _Базы данных_ выберите рабочую БД {dv}, установите переключатель в режим *Использовать выбранную в списке базу данных* и нажмите *Далее*.
// . Будет предложено обновить базу данных до новой версии. Выберите вариант *ДА*.
// . На следующей странице не изменяйте выбор обновляемых библиотек карточек. Нажмите *Далее*.
// . На странице _Параметры базы данных_ нажмите *Далее*. Появится запрос на подтверждение обновления -- согласитесь. Процесс обновления займет некоторое время.
// // . На странице настройки производительности и перезапуска IIS нажмите *Далее*.
// . На странице _Загрузка специальной конфигурации {dm}_ нажмите *Далее*, чтобы загрузить стандартную конфигурацию приложения {dm} или пропустите шаг нажатием кнопки *Пропустить*.
// +
// WARNING: Данные действия приведут к загрузке стандартных настроек приложения _{dm}_ и модуля _{ad}_. Если требуется сохранить собственные настройки, на шаге "Загрузка специальной конфигурации" нажмите кнопку *Пропустить*, подробнее см. в xref:documentmgmt:admin:update-module.adoc#update-no-overwrite[документации по обновлению модуля {dm}].
// +
// . Повторите предыдущий шаг для страницы _Загрузка специальной конфигурации {ad}_.
// . Подтвердите настройки Workflow и выйдите из мастера.
. Обновите версию модуля на всех узлах кластера {dv}, СУБП и Web-клиента.
. Клиентские компоненты модуля на компьютерах пользователей будут обновлены автоматически при запуске {wincl}а.
+
Самостоятельно обновить клиентские компоненты можно из пакета установки `Docsvision Worker service client.msi`.

:!update:

:docname: launch
:page-module: admin
:page-relative-src-path: launch.adoc
:page-origin-url: https://github.com/Docsvision/Worker-Antora.git
:page-origin-start-path:
:page-origin-refname: 6.1
:page-origin-reftype: branch
:page-origin-refhash: 0d5cadd3daebde21bfc76e6f8e6b90260f0d4e84
[#admin:launch:::]
=== Запуск Службы фоновых операций

Работу _Службы {ws}_ обеспечивает служба *{wss-new}*. Данная служба должна быть запущена от имени учётной записи с правами администратора, т.е. для УЗ требуется членство в группе *{dv-sys-wf-dir}* в справочнике сотрудников на сервере {dv}.
// учётная запись должна быть добавлена в группу локальных администраторов на сервере {dv}.

_Cлужба {ws}_ может использовать сервис перештамповки подписей.
// tag::cpus[]
Для корректной работы службы {ws} с использованием сервиса перештамповки подписей необходимо использовать машину, имеющую как минимум два процессора.
// end::cpus[]

При первом запуске _Служба {ws}_ читает список типов установленных расширений и прописывает себя вместе с расширениями в _{sett-serv}_. Таким образом Служба {ws} идентифицирует себя и открывает доступ к своим функциям для системы {dv}.

В дальнейшем, когда _Служба {ws}_ прочитает конфигурацию и создаст расширения, для работы отдельных расширений могут потребоваться права пользователей из группы _{dv-sys-wf-dir}_ в справочнике сотрудников {dv}.

Все настройки службы считываются из _{of-sett-serv}_.

[NOTE]
====
// tag::console[]
При использовании модуля _{mc}_ убедитесь, что сервер {dv} на Linux активен и на нём запущены службы *{wacss-new}*, *{extapi-new}*, *{wacs-new}* и *{wss-new}*.

// , что учётная запись, под которой запускается _Служба {ws}_ включена в группу *{dv-sett-serv-admins-serv}* на сервере с модулем _{mc}_.
// end::console[]
В противном случае будет недоступен xref:6.1@mgmtconsole:user:worker-service.adoc[узел Службы {ws}] в {of-mc}.
====

:docname: work-log
:page-module: admin
:page-relative-src-path: work-log.adoc
:page-origin-url: https://github.com/Docsvision/Worker-Antora.git
:page-origin-start-path:
:page-origin-refname: 6.1
:page-origin-reftype: branch
:page-origin-refhash: 0d5cadd3daebde21bfc76e6f8e6b90260f0d4e84
[#admin:work-log:::]
=== Журнал работы
:serv: {wss-new}


Журнал работы модуля в локальной файловой системе располагается в каталоге `/var/log/docsvision`.


Пути к журналам и уровень журналирования настраиваются в конфигурационом файле `/usr/lib/docsvision/workerservice/Configuration.json` в параметрах:

* `LogFile` -- путь к журналу работы.
* `LogTraceLevel` -- уровень журналирования.
+
.Администратор может настроить следующие уровни журналирования:
** Журналирование отключено (Off) = `0`.
** Только ошибки (Error) = `1`.
** Ошибки и предупреждения (Warning) = `2`.
** Сообщения, ошибки и предупреждения (Info) = `3`.
** Подробное журналирование (Verbose) = `4`.

Учётная запись, под которой запущена Служба {ws}, должна обладать правами на запись в папку хранения журналов.

:!serv:

:docname: introduction
:page-module: extensions
:page-relative-src-path: introduction.adoc
:page-origin-url: https://github.com/Docsvision/Worker-Antora.git
:page-origin-start-path:
:page-origin-refname: 6.1
:page-origin-reftype: branch
:page-origin-refhash: 0d5cadd3daebde21bfc76e6f8e6b90260f0d4e84
[#extensions:introduction:::]
== Разработка расширений службы фоновых операций

Если вы использовали расширения Службы {ws} предыдущих версий и хотели бы использовать эту возможность в новой версии, xref:system::technical-support.adoc[обратитесь] в техническую поддержку {dv}.

//Инструкция по разработке дополнительных компонентов, расширяющих функциональные возможности модуля {dv} 5. Служба {ws}. В инструкции приведено описание основных объектов API Службы {ws}, описание программных сервисов, предоставляемых API и примеры разработки.
//
//Документ предназначен для программистов, планирующих использовать Службу {ws} для обработки задач системы {dv} или других систем.
//
//== Уровень подготовки разработчика
//
//Предполагается, что разработчик расширений для Службы {ws} знаком с принципами разработки программ на языке C# в IDE Visual Studio.
